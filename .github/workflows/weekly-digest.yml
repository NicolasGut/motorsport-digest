name: Weekly Motorsport Digest

on:
  # Ex√©cution automatique tous les dimanches √† 18h UTC
  schedule:
    - cron: '0 18 * * 0'  # 18h UTC = 19h Paris hiver, 20h Paris √©t√©
  
  # Permettre ex√©cution manuelle
  workflow_dispatch:

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    
    steps:
    # ============================================
    # 1. CHECKOUT REPOSITORY
    # ============================================
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # R√©cup√©rer tout l'historique
    
    # ============================================
    # 2. SETUP PYTHON
    # ============================================
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache des d√©pendances
    
    # ============================================
    # 3. INSTALL DEPENDENCIES
    # ============================================
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ============================================
    # 4. VERIFY ENVIRONMENT
    # ============================================
    - name: Verify installation
      run: |
        python --version
        pip list
        echo "‚úÖ Dependencies installed"
    
    # ============================================
    # 5. RUN MAIN PIPELINE
    # ============================================
    - name: Generate weekly digest
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        # D√©sactiver proxies qui interf√®rent avec Anthropic client
        NO_PROXY: "*"
      run: |
        echo "üèéÔ∏è  Starting digest generation..."
        
        # Unset proxy variables before running
        unset HTTP_PROXY HTTPS_PROXY http_proxy https_proxy
        
        # Run with wrapper for better error handling
        python run_github_action.py
        
        echo "‚úÖ Pipeline completed"
    
    # ============================================
    # 6. COMMIT & PUSH RESULTS
    # ============================================
    - name: Commit and push digest
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Ajouter fichiers g√©n√©r√©s
        git add docs/
        git add data/veille_motorsport.db || true  # Base de donn√©es (optionnel)
        
        # Commit avec date
        DIGEST_DATE=$(date +'%Y-%m-%d %H:%M')
        git commit -m "üì∞ Weekly digest: $DIGEST_DATE" || echo "No changes to commit"
        
        # Push
        git push
    
    # ============================================
    # 7. NOTIFICATION (optionnel)
    # ============================================
    - name: Success notification
      if: success()
      run: |
        echo "‚úÖ Digest successfully generated and published!"
        echo "üåê View at: https://${{ github.repository_owner }}.github.io/motorsport-digest/"
    
    - name: Failure notification
      if: failure()
      run: |
        echo "‚ùå Digest generation failed!"
        echo "Check logs above for details"
